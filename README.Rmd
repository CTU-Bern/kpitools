---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

# kpitools

`r badger::badge_custom("dev version", as.character(packageVersion("kpitools")), "blue", "https://github.com/CTU-Bern/kpitools")`
[![R-CMD-fullcheck](https://github.com/CTU-Bern/kpitools/actions/workflows/R-CMD-full.yaml/badge.svg)](https://github.com/CTU-Bern/kpitools/actions/workflows/R-CMD-full.yaml)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.path = "man/figures/README-")
```

Tools for creating key performance indicator (KPI) reports.

# Example usage 

The package can be installed from [github](https://github.com/CTU-Bern/kpitools) via the `remotes` package

```{r gh-installation, eval = FALSE}
# install.packages("remotes")
remotes::install_github("CTU-Bern/kpitools")
```

Note that `remotes` treats any warnings (e.g. that a certain package was built under a different version of R) as errors. If you see such an error, run the following line and try again:

```{r remotes-error, eval = FALSE}
Sys.setenv(R_REMOTES_NO_ERRORS_FROM_WARNINGS = "true")
```

And loaded via
```{r, message=FALSE}
library(kpitools)
```

## Calculating KPIs 

The main function is the `kpi` function. A dataframe is passed to it together with the `var`iable that is of interest for the current KPI. A summary function also needs to be passed which determines how the KPI is calculated.
```{r, eval = TRUE}
data(mtcars)

mtcars$highmpg <- mtcars$mpg > 20

mtcars %>%
  kpi(var = "highmpg",             # variable to be summarized (focus of the KPI)
      kpi_fn = kpi_fn_perc,        # summary function
      txt = "Percentage MPG > 25") # (optional) nicer text to add to tables

```


It is also possible to calculate the KPIs over specific groups via the `by` option:
```{r}
mtcars %>%
  kpi(var = "highmpg",             # variable to be summarized (focus of the KPI)
      kpi_fn = kpi_fn_perc,        # summary function
      txt = "Percentage MPG > 20", # (optional) nicer text to add to tables
      by = "am")                   # (optional) stratifying variable

```

The `by` argument also works over multiple variables:
```{r}
mtcars %>%
  kpi(var = "highmpg",             # variable to be summarized (focus of the KPI)
      kpi_fn = kpi_fn_perc,        # summary function
      txt = "Percentage MPG > 20", # (optional) nicer text to add to tables
      by = c("am", "gear"))        # (optional) stratifying variables

```

KPIs are often reported with cutoffs (for use with a traffic light type approach). Cutoffs can be passed to `kpi`, with or without labels.
```{r, eval = FALSE}
# without labels
mtcars %>%
  kpi(var = "highmpg",                # variable to be summarized (focus of the KPI) 
      kpi_fn = kpi_fn_perc,           # summary function 
      txt = "Percentage MPG > 20",    # (optional) nicer text to add to tables
      by = "am",                      # (optional) stratifying variable
      cutpoints = c(0,33.3,66.6,100)) # (optional) cutoff points

```

Add in cutoffs for quality with labels
```{r}
mtcars %>%
  kpi(var = "highmpg",                        # variable to be summarized (focus of the KPI)  
      kpi_fn = kpi_fn_perc,                   # summary function   
      txt = "Percentage MPG > 20",            # (optional) nicer text to add to tables 
      by = "am",                              # (optional) stratifying variable 
      cutpoints = c(0,33.3,66.6,100),         # (optional) cutoff points 
      cutlabels = c("Low", "Medium", "High")) # (optional) labels for the cutoff points

```

## Visualising variation among levels of the study hierarchy

There is a plot method for the output from `kpi` which returns a list of `ggplot2` objects.
```{r, fig.height=1.5}
kpi <- mtcars %>%
  kpi(var = "highmpg", 
      kpi_fn = kpi_fn_perc, 
      txt = "Percentage MPG > 20",
      by = "cyl")

(plot <- plot(kpi))
```

`ggplot2` objects allow for easy modification after their creation for further customisation.
```{r, fig.height=1.5}
plot$cyl +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.margin = margin(0,0,0,0)
        )
  
```

A `ggplot2` theme is also provided which implements modifications similar to those above - `theme_kpitools`.
```{r, fig.height=1.5}
plot$cyl +
  theme_kpitools()
```




